""" Libs """
import cv2

debug = 0
class FaceDetector:
    """Detect human face from image"""

    def __init__(self, dnn_proto_text, dnn_model):
        """Initialization"""
        # dnn_proto_text='models/deploy.prototxt'
        # dnn_model='models/res10_300x300_ssd_iter_140000.caffemodel'
        self.face_net = cv2.dnn.readNetFromCaffe(dnn_proto_text, dnn_model)
        self.detection_result = None

    
    def get_faceboxes(self, image, threshold):
        """
        Get the bounding box of faces in image using dnn.
        """
        rows, cols, _ = image.shape

        confidences = []
        faceboxes = []

        self.face_net.setInput(cv2.dnn.blobFromImage(image, 1.0, (300, 300), (104.0, 177.0, 123.0), False, False))

        detections = self.face_net.forward()

        if debug > 2 :
            print("number of face found:", len (detections[0, 0, :, :]))

        for result in detections[0, 0, :, :]:
            confidence = result[2]
            if confidence >= threshold:
                x_left_bottom = int(result[3] * cols)
                y_left_bottom = int(result[4] * rows)
                x_right_top = int(result[5] * cols)
                y_right_top = int(result[6] * rows)
                confidences.append(confidence)
                faceboxes.append([x_left_bottom, y_left_bottom, x_right_top, y_right_top])

        if debug > 2 :
                print("number of detection > threshold", len(faceboxes))

        self.detection_result = [faceboxes, confidences]

        return confidences, faceboxes


    def draw_all_result(self, image):
        """Draw the detection result on image"""
        for facebox, conf in self.detection_result:
            cv2.rectangle(image, (facebox[0], facebox[1]),
                          (facebox[2], facebox[3]), (0, 255, 0))
            label = "face: %.4f" % conf
            label_size, base_line = cv2.getTextSize(
                label, cv2.FONT_HERSHEY_SIMPLEX, 0.5, 1)

            cv2.rectangle(image, (facebox[0], facebox[1] - label_size[1]),
                          (facebox[0] + label_size[0],
                           facebox[1] + base_line),
                          (0, 255, 0), cv2.FILLED)
            cv2.putText(image, label, (facebox[0], facebox[1]),
                        cv2.FONT_HERSHEY_SIMPLEX, 0.5, (0, 0, 0))
